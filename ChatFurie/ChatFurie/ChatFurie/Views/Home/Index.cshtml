@{
    ViewData["Title"] = "Home Page";
}
@{
    int userID = Convert.ToInt32(User.Claims.ToList()[1].Value);
    ChatContext chatContext = new ChatContext();
    var user = chatContext.Users.Find(userID);
}

<div class="modal fade" id="modalWindow" tabindex="-1" role="dialog" aria-labelledby="ModalWindow" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div id="modalContent" class="modal-content">
        </div>
    </div>
</div>

<div class="f-column column">
    <div class="user-info">
        <img src="~/images/DefaultUserImg.png" class="img40" />
        <span>@Html.StringLengthValidate(user.Login)</span>
        <img src="~/images/condition-on.jpg" class="img10" />
    </div>
    <div class="search">
        <input id="search-input" type="text" />
    </div>
    <div class="tabs-line">
        <span name="list-output" class="tab-header tab-header-active">Conversations</span>
        <span name="Notifications" class="tab-header">Notifications</span>
    </div>
    <div id="list-output" class="list-output">
    </div>
    <div id="Notifications" class="list-output" style="display:none">
    </div>
</div>
<div id="s-column" class="s-column column">
    <img style="width:100%" />
</div>


<script src="~/lib/jquery/dist/jquery.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.1/js/toastr.js"></script>
<script>

    toastr.options = {
        "closeButton": false,
        "debug": false,
        "newestOnTop": false,
        "progressBar": false,
        "positionClass": "toast-top-right",
        "preventDuplicates": false,
        "onclick": null,
        "showDuration": 300,
        "hideDuration": 1000,
        "timeOut": 5000,
        "extendedTimeOut": 1000,
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
    }

    // On Start page
    $(function () {

        var modalWindow = $("#modalWindow");
        var modalWindowContent = $("#modalContent");


        function GetStartPage() {
            $("#s-column").html('<img style="width:100%" />');
        }

        function LoadConversations() {
            AjaxPost({ "user": "@userID" }, "@Url.Action("GetConversations","Home")", function (e) {
                $("#list-output").html(e);
                $(".conversation").click(function () {
                    OpenConversation($(this).attr("id"));
                });
            });
        }

        function LoadNotifications() {
            AjaxPost({ "user": "@userID" }, "@Url.Action("GetNotifications","Home")", function (e) {
                $("#Notifications").html(e);
                $(".notification").click(function () {
                    OpenNotification($(this).attr("id"));
                });
            });
        }

        LoadConversations();
        LoadNotifications();

        function OpenNotification(id) {
            AjaxPost({ "user": "@userID", "notification": id }, "@Url.Action("OpenNotification","Home")",
                function (e) {
                    $("#s-column").html(e);
                    $("#acceptFriend").click(function () {
                        var id = $(this).attr("name");
                        AjaxPost({ "user": "@userID", "notification": id }, "@Url.Action("AcceptFriend","Home")",
                            function (e) {
                                OpenConversation(e);
                                LoadNotifications();
                                LoadConversations();
                            });
                    });
                    $("#declineFriend").click(function () {
                        var id = $(this).attr("name");
                        AjaxPost({ "user": "@userID", "notification": id }, "@Url.Action("DeclineFriend","Home")",
                            function (e) {
                                GetStartPage();
                                LoadNotifications();
                            });
                    });
                });
        }

        // Searching conversations and friends
        $('#search-input').keyup(function () {
            var text = $(this).val().trim();
            if (text.length === 0) {
                LoadConversations();
            }
            else {
                AjaxPost({ "find": text, "user": "@userID" },
                    "@Url.Action("FindResult", "Home")",
                    function (e) {
                        $('#list-output').html(e);
                        $('.contact-find').click(function () { OpenContact($(this).attr("id")); });
                    });
            }
        });

        function OpenContact(id) {
            AjaxPost({ "user": "@userID", "another": id },
            "@Url.Action("OpenContact","Home")",
            function (e) {
                $('.s-column').html(e);
                InitOpenContact();
            });
        }

        function InitOpenContact() {
            $("#deleteFriend").click(function () {
            });
            $("#addFriend").click(function () {
                var nUser = $(this).attr("name");
                AjaxPost({ "user": "@userID", "newFriend": nUser },
                    "@Url.Action("AddFriend","Home")", function (e) {
                        if (!e)
                            toastr["error"]("Unreport exception");
                        else {
                            toastr["success"]("Success adding");
                            OpenContact(nUser);
                        }
                    });
            });
        }

        function OpenConversation(id) {
            AjaxPost({ "user": "@userID", "conversation": id }, "@Url.Action("OpenConversation", "Home")",
                function (e) {
                    $("#s-column").html(e);
                    /// Realize

                    $(".header-info").click(function () {
                        var id = $(this).attr("id");
                        AjaxPost({ "user": "@userID", "conversation": id }, "@Url.Action("ConversationInfo")",
                            function (e) {
                                $(modalWindowContent).html(e);
                                $(modalWindow).modal("show");
                            });
                    });

                });
        }

        /// Переписать под универсал!
        $('.tab-header').click(function () {
            var getElementActive = $('.tab-header.tab-header-active').first();
            var idActive = $(getElementActive).attr("name");
            var id = $(this).attr("name");
            if (this !== getElementActive) {
                $(this).attr("class", "tab-header tab-header-active");
                $('#' + id).css("display", "block");
                $(getElementActive).attr("class", "tab-header");
                $('#' + idActive).css("display","none");
            }
        });

    });


    function AjaxPost(data, url, success) {
        $.ajax({
            url: url,
            data: data,
            method: "POST",
            success: success,
            error: function (jqXHR, textStatus, errorThrown) {
                toastr["error"](jqXHR.responseText);
            }
        });
    }

    function AjaxGet(data, url, success) {
        $.ajax({
            url: url,
            data: data,
            method: "GET",
            success: success,
            error: function (error) {

            }
        });
    }

</script>


